{% extends "templates/base.html" %}
{% block title %}{{server.name}}{% endblock %}
{% block mainid %}server{% endblock %}
{% block content %}
<h1>{{server.name}}</h1>
<div class="server-action-buttons">
    <button class="start-server" onclick="socket.emit('start_server', {'server_id': serverId})">Start</button>
    <button class="stop-server" onclick="socket.emit('stop_server', {'server_id': serverId})" hidden>Stop</button>
    <button class="restart-server" onclick="socket.emit('restart_server', {'server_id': serverId})" hidden>Restart</button>
    <button class="run-command" onclick="runCommand()" hidden>Run Command</button>
</div>
<div class="server-console">{{get_server_output(server)}}</div>
<div class="server-files">

</div>
{% endblock %}
{% block script %}
<script>
    var serverStatus = { running: {% if server_status.running %}true{% else %}false{% endif %}, fully_started: {% if server_status.fully_started %}true{% else %}false{% endif %} };
    const serverId = {{server.id}};
    if (serverStatus.running) {
        document.querySelector(".start-server").hidden = true;
        if (serverStatus.fully_started) {
            document.querySelector(".stop-server").hidden = false;
            document.querySelector(".restart-server").hidden = false;
            document.querySelector(".run-command").hidden = false;
        }
    }
    socket.on("server_started", (data) => {
        if (data.server_id == serverId) {
            console.log("Server started:", data);
            serverStatus = {running: true, fully_started: false};
            document.querySelector(".start-server").hidden = true;
            const consoleDiv = document.querySelector(".server-console");
            consoleDiv.textContent = "";
        }
    });
    socket.on("server_stopped", (data) => {
        if (data.server_id == serverId) {
            console.log("Server stopped:", data);
            serverStatus = {running: false, fully_started: false};
            document.querySelector(".start-server").hidden = false;
            document.querySelector(".stop-server").hidden = true;
            document.querySelector(".restart-server").hidden = true;
            document.querySelector(".run-command").hidden = true;
        }
    });
    socket.on("server_output", (data) => {
        if (data.server_id == serverId) {
            console.log("Server output:", data);
            const consoleDiv = document.querySelector(".server-console");
            const isAtBottom = consoleDiv.scrollHeight - consoleDiv.clientHeight <= consoleDiv.scrollTop + 1;
            consoleDiv.textContent += data.output;
            if (isAtBottom) {
                consoleDiv.scrollTop = consoleDiv.scrollHeight - consoleDiv.clientHeight;
            }
        }
    });
    function runCommand() {
        const command = prompt("Enter the command to run:");
        if (command) {
            fetch(`/servers/${serverId}/command`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: command
                }),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.output)
            })
            .catch(error => {
                alert('An error occurred: ' + error.message);
            });
        }
    }
    socket.on("server_fully_started", (data) => {
        if (data.server_id == serverId) {
            console.log("Server fully started:", data);
            serverStatus.fully_started = true;
            document.querySelector(".stop-server").hidden = false;
            document.querySelector(".restart-server").hidden = false;
            document.querySelector(".run-command").hidden = false;
        }
    });
    function listDir(directory) {
        fetch(`/server/${serverId}/files/${directory}`, {credentials: 'include'})
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                const filesDiv = document.querySelector(".server-files");
                filesDiv.innerHTML = "";
                backelement = document.createElement("div");
                backelement.textContent = "..";
                backelement.classList.add("directory");
                backelement.onclick = () => listDir(directory.split("/").slice(0, -1).join("/")); // uhh
                filesDiv.appendChild(backelement);
                data.files.forEach(file => {
                    const fileElement = document.createElement("div");
                    if (file.type === 'dir') {
                        fileElement.textContent = "ðŸ“ " + file.name;
                        fileElement.classList.add("directory");
                        fileElement.onclick = () => listDir(directory ? `${directory}/${file.name}` : file.name);
                    } else {
                        fileElement.textContent = "ðŸ“„ " + file.name;
                        fileElement.classList.add("file");
                    }
                    filesDiv.appendChild(fileElement);
                });
            })
            .catch(error => {
                alert('An error occurred: ' + error.message);
            });
    }
    listDir("");
</script>
{% endblock %}