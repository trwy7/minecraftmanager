{% extends "templates/base.html" %}
{% block title %}{{server.name}}{% endblock %}
{% block mainid %}server{% endblock %}
{% block content %}
<h1>{{server.name}}</h1>
<div class="server-action-buttons">
    <button class="start-server" onclick="socket.emit('start_server', {'server_id': serverId})">Start</button>
    <button class="stop-server" onclick="socket.emit('stop_server', {'server_id': serverId})" hidden>Stop</button>
    <button class="restart-server" onclick="socket.emit('restart_server', {'server_id': serverId})" hidden>Restart</button>
    <button class="run-command" onclick="runCommand()" hidden>RCON</button>
    <button onclick="showTab('console')" id="console-tab" hidden>Console</button>
    <button onclick="showTab('files')" id="files-tab">Files</button>
    <button onclick="uploadFile()" id="upload-tab" hidden>Upload File</button>
    <button onclick="createDirectory()" id="create-folder" hidden>Create folder</button>
</div>
<div class="server-console">
    <div class="server-console-inner">{{get_server_output(server)}}</div><input type="text" class="server-command-input" placeholder="Command" onkeydown="sendCommand(event)">
</div>
<div class="server-files" hidden>

</div>
{% endblock %}
{% block script %}
<script>
    var serverStatus = { running: {% if server_status.running %}true{% else %}false{% endif %}, fully_started: {% if server_status.fully_started %}true{% else %}false{% endif %} };
    const serverId = {{server.id}};
    var currentDirectory = "";
    if (serverStatus.running) {
        document.querySelector(".start-server").hidden = true;
        if (serverStatus.fully_started) {
            document.querySelector(".stop-server").hidden = false;
            document.querySelector(".restart-server").hidden = false;
            //document.querySelector(".run-command").hidden = false;
        } else {
            document.querySelector(".server-command-input").hidden = true;
        }
    } else {
        document.querySelector(".server-command-input").hidden = true;
    }
    socket.on("server_started", (data) => {
        if (data.server_id == serverId) {
            console.log("Server started:", data);
            serverStatus = {running: true, fully_started: false};
            document.querySelector(".start-server").hidden = true;
            const consoleDiv = document.querySelector(".server-console-inner");
            consoleDiv.textContent = "";
        }
    });
    socket.on("server_stopped", (data) => {
        if (data.server_id == serverId) {
            console.log("Server stopped:", data);
            serverStatus = {running: false, fully_started: false};
            document.querySelector(".start-server").hidden = false;
            document.querySelector(".stop-server").hidden = true;
            document.querySelector(".restart-server").hidden = true;
            document.querySelector(".run-command").hidden = true;
            document.querySelector(".server-command-input").hidden = true;
        }
    });
    socket.on("server_output", (data) => {
        if (data.server_id == serverId) {
            console.log("Server output:", data);
            const consoleInDiv = document.querySelector(".server-console-inner");
            const consoleDiv = document.querySelector(".server-console");
            const isAtBottom = consoleDiv.scrollHeight - consoleDiv.clientHeight <= consoleDiv.scrollTop + 1;
            consoleInDiv.textContent += data.output;
            if (isAtBottom) {
                consoleDiv.scrollTop = consoleDiv.scrollHeight - consoleDiv.clientHeight;
            }
        }
    });
    function runCommand() {
        const command = prompt("Enter the command to run:");
        if (command) {
            fetch(`/servers/${serverId}/command`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    command: command
                }),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.output)
            })
            .catch(error => {
                alert('An error occurred: ' + error.message);
            });
        }
    }
    socket.on("server_fully_started", (data) => {
        if (data.server_id == serverId) {
            console.log("Server fully started:", data);
            serverStatus.fully_started = true;
            document.querySelector(".stop-server").hidden = false;
            document.querySelector(".restart-server").hidden = false;
            //document.querySelector(".run-command").hidden = false;
            const consoleDiv = document.querySelector(".server-console");
            const atBottom = consoleDiv.scrollHeight - consoleDiv.clientHeight <= consoleDiv.scrollTop + 1;
            document.querySelector(".server-command-input").hidden = false;
            if (atBottom) {
                consoleDiv.scrollTop = consoleDiv.scrollHeight - consoleDiv.clientHeight;
            }
        }
    });
    function listDir(directory) {
        fetch(`/server/${serverId}/files/${directory}`, {credentials: 'include'})
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                const filesDiv = document.querySelector(".server-files");
                filesDiv.innerHTML = "";
                if (directory) {
                    backelement = document.createElement("div");
                    backelement.textContent = "â¤´ï¸ ..";
                    backelement.classList.add("directory");
                    backelement.onclick = () => listDir(directory.split("/").slice(0, -1).join("/")); // uhh
                    filesDiv.appendChild(backelement);
                }
                data.files.forEach(file => {
                    const fileElement = document.createElement("div");
                    if (file.type === 'dir') {
                        fileElement.textContent = "ðŸ“ " + file.name;
                        fileElement.classList.add("directory");
                        fileElement.onclick = () => listDir(directory ? `${directory}/${file.name}` : file.name);
                    } else {
                        fileElement.textContent = "ðŸ“„ " + file.name;
                        fileElement.classList.add("file");
                        fileElement.onclick = () => {
                            window.location.href = `/server/${serverId}/files/${directory ? `${directory}/${file.name}` : file.name}`
                        };
                    }
                    // file action buttons
                    const renameButton = document.createElement("button");
                    renameButton.textContent = "Rename";
                    renameButton.classList.add("rename-button");
                    renameButton.onclick = (e) => {
                        e.stopPropagation();
                        renameFile(file.name);
                    };
                    fileElement.appendChild(renameButton);
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "Delete";
                    deleteButton.classList.add("delete-button");
                    deleteButton.onclick = (e) => {
                        e.stopPropagation();
                        deleteFile(file.name);
                    };
                    fileElement.appendChild(deleteButton);
                    // add the element
                    filesDiv.appendChild(fileElement);
                });
                currentDirectory = directory;
            })
            .catch(error => {
                alert('An error occurred: ' + error.message);
            });
    }
    function showTab(tab) {
        if (tab === 'console') {
            document.querySelector(".server-console").hidden = false;
            document.querySelector(".server-files").hidden = true;
            document.getElementById("console-tab").hidden = true;
            document.getElementById("files-tab").hidden = false;
            document.getElementById("upload-tab").hidden = true;
            document.getElementById("create-folder").hidden = true;
        } else {
            document.querySelector(".server-console").hidden = true;
            document.querySelector(".server-files").hidden = false;
            document.getElementById("console-tab").hidden = false;
            document.getElementById("files-tab").hidden = true;
            document.getElementById("upload-tab").hidden = false;
            document.getElementById("create-folder").hidden = false;
        }
    }
    function uploadFile() {
        // Allow multiple file uploads at once, and then send individual PUT requests for each file
        const input = document.createElement("input");
        input.type = "file";
        input.multiple = true;
        input.onchange = () => {
            const files = input.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append("file", file);
                const path = currentDirectory ? `${currentDirectory}/${file.name}` : file.name;
                fetch(`/server/${serverId}/files/${path}`, {
                    method: 'PUT',
                    body: formData,
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error uploading ' + file.name + ': ' + data.error);
                    } else {
                        listDir(currentDirectory);
                    }
                })
                .catch(error => {
                    alert('An error occurred while uploading ' + file.name + ': ' + error.message);
                });
            }
        };
        input.click();
    }
    function createDirectory() {
        const dirName = prompt("Folder name:");
        if (dirName) {
            const path = currentDirectory ? `${currentDirectory}/${dirName}` : dirName;
            fetch(`/server/${serverId}/files/${path}`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    listDir(currentDirectory);
                }
            })
            .catch(error => {
                alert('An error occurred: ' + error.message);
            });
        }
    }
    function renameFile(oldPath) {
        const newPath = prompt("New name:", oldPath);
        if (newPath) {
            const path = currentDirectory ? `${currentDirectory}/${oldPath}` : oldPath;
            fetch(`/server/${serverId}/files/${path}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({new_name: newPath}),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    listDir(currentDirectory);
                }
            })
            .catch(error => {
                alert('An error occurred: ' + error.message);
            });
        }
    }
    function deleteFile(path) {
        if (confirm(`Are you sure you want to delete ${path}?`)) {
            const fullPath = currentDirectory ? `${currentDirectory}/${path}` : path;
            fetch(`/server/${serverId}/files/${fullPath}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    listDir(currentDirectory);
                }
            })
            .catch(error => {
                alert('An error occurred: ' + error.message);
            });
        }
    }
    document.addEventListener("DOMContentLoaded", () => {
        const consoleDiv = document.querySelector(".server-console");
        consoleDiv.scrollTop = consoleDiv.scrollHeight - consoleDiv.clientHeight;
    });
    let cmdhistory = [];
    let cmdhistoryindex = 0;
    function sendCommand(event) {
        if (event.key === "Enter") {
            const input = event.target;
            const command = input.value.trim();
            if (command) {
                socket.emit("send_command", {server_id: serverId, command: command});
                cmdhistory.push(command);
                cmdhistoryindex = cmdhistory.length;
                input.value = "";
            }
        } else if (event.key === "ArrowUp") {
            if (cmdhistoryindex > 0) {
                cmdhistoryindex--;
                event.target.value = cmdhistory[cmdhistoryindex];
            }
        } else if (event.key === "ArrowDown") {
            if (cmdhistoryindex < cmdhistory.length - 1) {
                cmdhistoryindex++;
                event.target.value = cmdhistory[cmdhistoryindex];
            } else {
                cmdhistoryindex = cmdhistory.length;
                event.target.value = "";
            }
        }
    }
    listDir("");
</script>
{% endblock %}